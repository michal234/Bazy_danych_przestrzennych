1. CREATE DATABASE s290135;
2. CREATE SCHEMA firma;
3. CREATE ROLE ksiegowosc;
GRANT SELECT ON ALL TABLES IN SCHEMA firma TO ksiegowosc;
4. a)
CREATE TABLE firma.pracownicy( id_pracownika INT NOT NULL UNIQUE, imie VARCHAR, nazwisko VARCHAR, adres VARCHAR, telefon VARCHAR(9) );
CREATE TABLE firma.godziny( id_godziny INT NOT NULL UNIQUE, data DATE, liczba_godzin INT, id_pracownika INT NOT NULL );
CREATE TABLE firma.pensja_stanowisko( id_pensji INT NOT NULL UNIQUE, stanowisko VARCHAR, kwota FLOAT(2) );
CREATE TABLE firma.premia( id_premii INT NOT NULL UNIQUE, rodzaj VARCHAR, kwota FLOAT(2) );
CREATE TABLE firma.wynagrodzenie( id_wynagrodzenia INT NOT NULL UNIQUE, data DATE, id_pracownika INT NOT NULL, id_godziny INT NOT NULL, id_pensji INT NOT NULL, id_premii INT NOT NULL);

b)
ALTER TABLE firma.pracownicy ADD PRIMARY KEY(id_pracownika);
ALTER TABLE firma.godziny ADD PRIMARY KEY(id_godziny);
ALTER TABLE firma.pensja_stanowisko ADD PRIMARY KEY(id_pensji);
ALTER TABLE firma.premia ADD PRIMARY KEY(id_premii);
ALTER TABLE firma.wynagrodzenie ADD PRIMARY KEY(id_wynagrodzenia);

c)
ALTER TABLE firma.godziny ADD FOREIGN KEY(id_pracownika) REFERENCES firma.pracownicy(id_pracownika);
ALTER TABLE firma.wynagrodzenie ADD FOREIGN KEY(id_godziny) REFERENCES firma.godziny(id_godziny);
ALTER TABLE firma.wynagrodzenie ADD FOREIGN KEY(id_pensji) REFERENCES firma.pensja_stanowisko(id_pensji);
ALTER TABLE firma.wynagrodzenie ADD FOREIGN KEY(id_premii) REFERENCES firma.premia(id_premii);

d)
CREATE CLUSTERED INDEX pracownik_ind ON firma.wynagrodzenie(id_pracownika);

e)
COMMENT ON TABLE firma.pracownicy IS 'Zawiera dane o pracownikach firmy';
COMMENT ON TABLE firma.godziny IS 'Zawiera dane o godzinach przepracowanych przez pracownika';
COMMENT ON TABLE firma.pensja_stanowisko IS 'Zawiera dane o pensji w odniesieniu do stanowiska';
COMMENT ON TABLE firma.premia IS 'Zawiera dane o możliwych premiach i ich wielkościach';
COMMENT ON TABLE firma.wynagrodzenie IS 'Zawiera dane o tym, jakie wynagrodzenie dostal dany pracownik uwzgleniajac liczbe godzin, pensje, premie i date wyplaty wynagrodzenia';

f)
ALTER TABLE firma.godziny ADD FOREIGN KEY(id_pracownika) REFERENCES firma.pracownicy(id_pracownika) ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE firma.wynagrodzenie ADD FOREIGN KEY(id_godziny) REFERENCES firma.godziny(id_godziny) ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE firma.wynagrodzenie ADD FOREIGN KEY(id_pensji) REFERENCES firma.pensja_stanowisko(id_pensji) ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE firma.wynagrodzenie ADD FOREIGN KEY(id_premii) REFERENCES firma.premia(id_premii) ON UPDATE NO ACTION ON DELETE NO ACTION;

5.
a)
ALTER TABLE firma.godziny ADD COLUMN miesiac TYPE INT;
ALTER TABLE firma.godziny ADD COLUMN tydzien TYPE INT;
b)
ALTER TABLE firma.wynagrodzenie ALTER COLUMN data TYPE VARCHAR;

INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (1, 'Adam', 'Adamski', 'Amsterdam', '123456789');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (2, 'Beata', 'Baranska', 'Bydgoszcz', '222222222');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (3, 'Celina', 'Cudowna', 'Ciechocinek', '333333333');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (4, 'Darek', 'Dariusz', 'Dubaj', '444444444');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (5, 'Ewa', 'Elipsa', 'Elblag', '555555555');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (6, 'Franek', 'Fachowiec', 'Frombork', '666666666');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (7, 'Gienek', 'Golonka', 'Gliwice', '777777777');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (8, 'Hanna', 'Handziak', 'Hrubieszow', '888888888');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (9, 'Ireneusz', 'Iwanicki', 'Inowroclaw', '999999999');
INSERT INTO firma.pracownicy(id_pracownika, imie, nazwisko, adres, telefon) VALUES (10, 'Justyna', 'Jaskolka', 'Jastrzebie', '987654321');

INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (1, '2020-08-03', 8, 4, 8, 33);
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (2, '2020-08-10', 4, 1, 8, 33);
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (3, '2020-08-12', 8, 8, 8, 33);
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (4, '2020-07-30'. 10, 10, 7, 31);
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (5, '2020-08-20', 6, 2, 8, 34);
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (6, '2020-08-20', 8, 5, 8, 34);
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (7, '2020-08-28', 5, 3, 8, 35);          
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (8, '2020-09-01', 8, 7, 9, 36);          
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (9, '2020-09-01', 8, 5, 9, 36);           
INSERT INTO firma.godziny(id_godziny, data, liczba_godzin, id_pracownika, miesiac, tydzien) VALUES (10, '2020-09-03', 6, 3, 9, 36);         

INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (1, 'prezes', 20000);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (2, 'wiceprezes', 15000);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (3, 'manager', 13500);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (4, 'elektryk', 3000);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (5, 'pracownik fizyczny', 2500);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (6, 'sprzataczka', 1500);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (7, 'magazynier', 2500);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (8, 'ksiegowa', 4000);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (9, 'kucharz', 3500);
INSERT INTO firma.pensja_stanowisko(id_pensji, stanowisko, kwota) VALUES (10, 'ochroniarz', 3200);

INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (1, 'brak', 0);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (2, 'Premia 1', 100);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (3, 'Premia 2', 200);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (4, 'Premia 3', 300);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (5, 'Premia 4', 500);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (6, 'Premia 5', 750);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (7, 'Premia 6', 1000);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (8, 'Premia 7', 1200);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (9, 'Premia 8', 1500);
INSERT INTO firma.premia(id_premii, rodzaj, kwota) VALUES (10, 'Premia 9', 2000);

INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (1, '2020-08-01', 1, 1, 1, 1);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (2, '2020-08-01', 8, 2, 5, 3);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (3, '2020-08-01', 10, 3, 8, 1);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (4, '2020-08-01', 2, 4, 7, 2);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (5, '2020-08-01', 5, 5, 5, 5);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (6, '2020-09-01', 1, 3, 1, 10);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (7, '2020-09-01', 3, 7, 8, 4);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (8, '2020-09-01', 5, 9, 5, 7);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (9, '2020-08-01', 4, 10, 9, 1);
INSERT INTO firma.wynagrodzenie(id_wynagrodzenia, data, id_pracownika, id_godziny, id_pensji, id_premii) VALUES (10, '2020-08-01', 3, 6, 8, 2);


6.
a) SELECT id_pracownika, nazwisko FROM firma.pracownicy;
b) SELECT DISTINCT pracownicy.id_pracownika FROM ((firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika) INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji) WHERE pensja_stanowisko.kwota > 1000 ORDER BY id_pracownika;
c) SELECT pracownicy.id_pracownika FROM (((firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika) INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji) INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii) WHERE pensja_stanowisko.kwota > 2000 AND premia.kwota = 0;
d) SELECT * FROM firma.pracownicy WHERE imie LIKE 'J%';
e) SELECT * FROM firma.pracownicy WHERE nazwisko LIKE '%n%' AND imie LIKE '%a';
f) --Przy założeniu, że w tabeli godziny są podane przepracowane godziny w ciągu miesiąca--
SELECT imie, nazwisko, (liczba_godzin-160) AS liczba_nadgodzin FROM firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika INNER JOIN firma.godziny ON wynagrodzenie.id_godziny = godziny.id_godziny WHERE liczba_godzin > 160; 
g) SELECT pracownicy.imie, pracownicy.nazwisko FROM ((firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika) INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji) WHERE pensja_stanowisko.kwota >= 1500 AND pensja_stanowisko.kwota <= 3000 GROUP BY pracownicy.nazwisko, pracownicy.imie;
h) SELECT imie, nazwisko FROM firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika INNER JOIN firma.godziny ON wynagrodzenie.id_godziny = godziny.id_godziny INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii WHERE liczba_godzin > 160 AND premia.kwota = 0;

7.
a) SELECT imie, nazwisko, kwota FROM (firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika) INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji GROUP BY imie, nazwisko, kwota ORDER BY pensja_stanowisko.kwota;
b) SELECT imie, nazwisko, pensja_stanowisko.kwota, premia.kwota FROM ((firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika) INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji) INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii GROUP BY imie, nazwisko, pensja_stanowisko.kwota, premia.kwota ORDER BY pensja_stanowisko.kwota DESC, premia.kwota DESC;
c) SELECT stanowisko, COUNT(pensja_stanowisko.id_pensji) AS Liczba_pracownikow FROM (firma.pensja_stanowisko INNER JOIN firma.wynagrodzenie ON pensja_stanowisko.id_pensji = wynagrodzenie.id_pensji) INNER JOIN firma.pracownicy ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika GROUP BY stanowisko;
d) SELECT AVG(pensja_stanowisko.kwota + premia.kwota) AS srednia_placa, MIN(pensja_stanowisko.kwota + premia.kwota) AS minimalna_placa, MAX(pensja_stanowisko.kwota + premia.kwota) AS maksymalna_placa FROM firma.pensja_stanowisko INNER JOIN firma.wynagrodzenie ON pensja_stanowisko.id_pensji = wynagrodzenie.id_pensji INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii WHERE stanowisko LIKE 'prezes';
e) SELECT SUM(pensja_stanowisko.kwota) + SUM(premia.kwota) AS suma_wynagrodzen FROM (firma.wynagrodzenie INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji) INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii;
f) SELECT pensja_stanowisko.stanowisko, SUM(pensja_stanowisko.kwota) + SUM(premia.kwota) AS suma_wynagrodzen FROM (firma.wynagrodzenie INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji) INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii GROUP BY stanowisko;
g) SELECT pensja_stanowisko.stanowisko, COUNT(premia.id_premii) AS liczba_premii FROM (firma.pensja_stanowisko INNER JOIN firma.wynagrodzenie ON pensja_stanowisko.id_pensji = wynagrodzenie.id_pensji) INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii WHERE premia.rodzaj NOT LIKE 'brak' GROUP BY stanowisko;
h) DELETE FROM firma.pracownicy WHERE pracownicy.id_pracownika IN (SELECT pracownicy.id_pracownika FROM firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii WHERE pensja_stanowisko.kwota + premia.kwota < 1200);

8.
a) ALTER TABLE firma.pracownicy ALTER COLUMN telefon TYPE VARCHAR;
UPDATE firma.pracownicy SET telefon = '(+48)' || telefon;
b) UPDATE firma.pracownicy SET telefon = SUBSTRING(telefon, 1, 8) || '-' || SUBSTRING(telefon, 9, 3) || '-' || SUBSTRING(telefon, 12, 3);
c) SELECT UPPER(imie), UPPER(nazwisko) FROM firma.pracownicy WHERE (LENGTH(pracownicy.nazwisko))=(SELECT MAX(LENGTH(pracownicy.nazwisko)) FROM firma.pracownicy);
d) SELECT MD5(imie || nazwisko || adres || telefon || pensja_stanowisko.kwota) FROM firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji;

9.
SELECT 'Pracownik ' || imie || ' ' || nazwisko || ', w dniu ' || EXTRACT(DAY FROM godziny.data) || '.' || EXTRACT(MONTH FROM godziny.data) || '.' || EXTRACT(YEAR FROM godziny.data) || ' otrzymal pensje calkowita na kwote ' || pensja_stanowisko.kwota + premia.kwota || ' zl, gdzie wynagrodzenie zasadnicze wynosilo: ' || pensja_stanowisko.kwota || ' zl, premia: ' || premia.kwota || ' zl, nadgodziny: ' || (godziny.liczba_godzin - 160)*pensja_stanowisko.kwota/160 || ' zl.' FROM firma.pracownicy INNER JOIN firma.wynagrodzenie ON pracownicy.id_pracownika = wynagrodzenie.id_pracownika INNER JOIN firma.pensja_stanowisko ON wynagrodzenie.id_pensji = pensja_stanowisko.id_pensji INNER JOIN firma.premia ON wynagrodzenie.id_premii = premia.id_premii INNER JOIN firma.godziny ON wynagrodzenie.id_godziny = godziny.id_godziny;